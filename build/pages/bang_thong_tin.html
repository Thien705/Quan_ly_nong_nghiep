<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <script src="/qlvt/build/assets/js/session.js"></script>
  <title>B·∫£ng th√¥ng tin</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Poppins', sans-serif; }
    table thead th {
      background-color: #16a34a;
      color: white !important;
      text-transform: uppercase;
      font-size: 0.9rem;
      letter-spacing: 0.5px;
    }
    table tbody tr:nth-child(even) {
      background-color: #f0fdf4;
    }
    table tbody tr:hover {
      background-color: #dcfce7;
      transition: 0.2s;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-green-100 to-green-50 min-h-screen flex">
  <!-- Sidebar -->
  <aside class="fixed inset-y-0 left-0 flex flex-col w-64 bg-gradient-to-b from-green-600 to-green-400 shadow-xl rounded-r-3xl z-50">
    <div class="flex items-center gap-2 px-6 py-6">
      <i class="fas fa-seedling text-3xl text-white"></i>
      <span class="text-xl font-bold text-white">Qu·∫£n l√Ω n√¥ng nghi·ªáp</span>
    </div>
    <nav class="flex flex-col gap-2 px-4">
      <a href="trang_chu.html" class="flex items-center gap-3 px-4 py-3 rounded-lg bg-green-700 text-white font-medium shadow transition duration-200 hover:shadow-xl hover:bg-green-800 hover:scale-105">
        <i class="fas fa-home text-xl"></i>
        <span>Trang ch·ªß</span>
      </a>
      <a href="bang_thong_tin.html" class="flex items-center gap-3 px-4 py-3 rounded-lg bg-green-700 text-white font-medium shadow transition duration-200 hover:shadow-xl hover:bg-green-800 hover:scale-105">
        <i class="fas fa-table text-xl"></i>
        <span>B·∫£ng th√¥ng tin</span>
      </a>
      <a href="Quan_ly.html" class="flex items-center gap-3 px-4 py-3 rounded-lg bg-green-700 text-white font-medium shadow transition duration-200 hover:shadow-xl hover:bg-green-800 hover:scale-105">
        <i class="fas fa-database text-xl"></i>
        <span>Qu·∫£n l√Ω th√¥ng tin</span>
      </a>
    </nav>
  </aside>

  <!-- Main content -->
  <main class="flex-1 ml-64 p-6 space-y-8">
    <!-- Khung t√™n user -->
    <div class="flex justify-between items-center mb-8">
      <div>
        <h1 class="text-2xl font-bold" id="welcome-title">Xin ch√†o</h1>
      </div>
      <div id="user-info" class="flex items-center gap-2">
        <span class="font-semibold text-green-700 border border-green-500 rounded px-3 py-1 bg-white shadow" id="username-display"></span>
        <a href="#" data-logout class="text-sm text-blue-500 underline">ƒêƒÉng xu·∫•t</a>
      </div>
    </div>
    <!-- Thanh t√¨m ki·∫øm -->
    <div class="flex justify-center mb-8">
      <input
        type="text"
        id="searchInput"
        placeholder="T√¨m ki·∫øm th√¥ng tin..."
        class="px-4 py-2 rounded-lg border border-green-300 shadow focus:outline-none focus:ring-2 focus:ring-green-400 w-80"
      />
    </div>

    <!-- B·∫£ng c√¢y tr·ªìng -->
    <div class="bg-white shadow-lg rounded-2xl overflow-hidden mb-8">  
      <div class="flex justify-between items-center p-6 border-b bg-green-50 sticky top-0 z-10">
        <h6 class="font-semibold text-lg text-green-700">üå± Danh s√°ch c√°c c√¢y tr·ªìng</h6>
        <button id="exportCayTrong" class="bg-green-500 text-white px-4 py-2 rounded font-semibold hover:bg-green-600">
          <i class="fas fa-file-excel mr-2"></i>Xu·∫•t Excel
        </button>
      </div>
      <div class="overflow-x-auto" style="max-height: 260px; overflow-y: auto;">
        <table class="w-full text-sm text-gray-700">
          <thead class="sticky top-0 z-10">
            <tr>
              <th class="px-6 py-3 text-left">STT</th>
              <th class="px-6 py-3 text-left">M√É C√ÇY</th>
              <th class="px-6 py-3 text-left">T√äN C√ÇY</th>
              <th class="px-6 py-3 text-left">C√ÅCH CANH T√ÅC</th>
              <th class="px-6 py-3 text-left">PH√ÇN B√ìN</th>
              <th class="px-6 py-3 text-left">NGU·ªíN G·ªêC</th>
            </tr>
          </thead>
          <tbody class="addListCayTrong"></tbody>
        </table>
      </div>
    </div>

    <!-- B·∫£ng n√¥ng d√¢n -->
    <div class="bg-white shadow-lg rounded-2xl overflow-hidden mb-8">
      <div class="flex justify-between items-center p-6 border-b bg-green-50 sticky top-0 z-10">
        <h6 class="font-semibold text-lg text-green-700">üë©‚Äçüåæ Danh s√°ch n√¥ng d√¢n</h6>
        <button id="exportNongDan" class="bg-green-500 text-white px-4 py-2 rounded font-semibold hover:bg-green-600">
          <i class="fas fa-file-excel mr-2"></i>Xu·∫•t Excel
        </button>
      </div>
      <div class="overflow-x-auto" style="max-height: 260px; overflow-y: auto;">
        <table class="w-full text-sm text-gray-700">
          <thead class="sticky top-0 z-10">
            <tr>
              <th class="px-6 py-3 text-left">STT</th>
              <th class="px-6 py-3 text-left">M√É ND</th>
              <th class="px-6 py-3 text-left">H·ªå T√äN</th>
              <th class="px-6 py-3 text-left">C∆Ø TR√ö</th>
            </tr>
          </thead>
          <tbody class="addListNongDan"></tbody>
        </table>
      </div>
    </div>

    <!-- B·∫£ng th·ª≠a ƒë·∫•t -->
    <div class="bg-white shadow-lg rounded-2xl overflow-hidden mb-8">
      <div class="flex justify-between items-center p-6 border-b bg-green-50 sticky top-0 z-10">
        <h6 class="font-semibold text-lg text-green-700">üìç Danh s√°ch c√°c th·ª≠a ƒë·∫•t</h6>
        <button id="exportThuaDat" class="bg-green-500 text-white px-4 py-2 rounded font-semibold hover:bg-green-600">
          <i class="fas fa-file-excel mr-2"></i>Xu·∫•t Excel
        </button>
      </div>
      <div class="overflow-x-auto" style="max-height: 260px; overflow-y: auto;">
        <table class="w-full text-sm text-gray-700">
          <thead class="sticky top-0 z-10">
            <tr>
              <th class="px-6 py-3 text-left">STT</th>
              <th class="px-6 py-3 text-left">M√É TH·ª¨A ƒê·∫§T</th>
              <th class="px-6 py-3 text-left">M√É N√îNG D√ÇN</th>
              <th class="px-6 py-3 text-left">ƒê·ªäA CH·ªà</th>
            </tr>
          </thead>
          <tbody class="addListThuaDat"></tbody>
        </table>
      </div>
    </div>

    <!-- B·∫£ng v·ª• tr·ªìng -->
    <div class="bg-white shadow-lg rounded-2xl overflow-hidden mb-8">
      <div class="flex justify-between items-center p-6 border-b bg-green-50 sticky top-0 z-10">
        <h6 class="font-semibold text-lg text-green-700">üåæ Danh s√°ch v·ª• tr·ªìng</h6>
        <button id="exportVuTrong" class="bg-green-500 text-white px-4 py-2 rounded font-semibold hover:bg-green-600">
          <i class="fas fa-file-excel mr-2"></i>Xu·∫•t Excel
        </button>
      </div>
      <div class="overflow-x-auto" style="max-height: 260px; overflow-y: auto;">
        <table class="w-full text-sm text-gray-700">
          <thead class="sticky top-0 z-10">
            <tr>
              <th class="px-6 py-3 text-left">STT</th>
              <th class="px-6 py-3 text-left">M√É N√îNG D√ÇN</th>
              <th class="px-6 py-3 text-left">M√É TH·ª¨A ƒê·∫§T</th>
              <th class="px-6 py-3 text-left">M√É C√ÇY</th>
              <th class="px-6 py-3 text-left">TH·ªúI GIAN B·∫ÆT ƒê·∫¶U</th>
              <th class="px-6 py-3 text-left">TH·ªúI GIAN K·∫æT TH√öC</th>
            </tr>
          </thead>
          <tbody class="addListVuTrong"></tbody>
        </table>
      </div>
    </div>

    <div class="flex justify-end mb-8">
      <button id="exportAllExcel" class="bg-blue-600 text-white px-5 py-2 rounded font-semibold hover:bg-blue-700">
        <i class="fas fa-file-excel mr-2"></i>Xu·∫•t t·∫•t c·∫£ Excel
      </button>
    </div>
  </main>

  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- SheetJS -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
    // Hi·ªÉn th·ªã t√™n ƒëƒÉng nh·∫≠p
    const username = localStorage.getItem("username");
    document.getElementById("username-display").textContent = username ? username : "Kh√°ch";
    document.getElementById("welcome-title").textContent = username ? `Xin ch√†o ${username}` : "Xin ch√†o Kh√°ch";

    // Hi·ªÉn th·ªã b·∫£ng c√¢y tr·ªìng
    function showCayTrong(){
      $.ajax({
        url: "http://localhost/qlvt/php/Cay_Trong/api_get_cay_trong.php",
        type: "POST",
        dataType: "json",
        success: function(res) {
          let s = '';
          let stt = 1;
          res.forEach(item => {
            s += `
              <tr>
                <td class="px-6 py-3">${stt++}</td>
                <td class="px-6 py-3">${item.MaC}</td>
                <td class="px-6 py-3">${item.TenC}</td>
                <td class="px-6 py-3">${item.CachCanhTac}</td>
                <td class="px-6 py-3">${item.PhanBon}</td>
                <td class="px-6 py-3">${item.NguonGoc}</td>
              </tr>`;
          });
          $('.addListCayTrong').html(s);
        }
      });
    }

    // Hi·ªÉn th·ªã b·∫£ng n√¥ng d√¢n
    function showNongDan(){
      $.ajax({
        url: "http://localhost/qlvt/php/Nong_Dan/api_get_nong_dan.php",
        type: "POST",
        dataType: "json",
        success: function(res) {
          let s = '';
          let stt = 1;
          res.forEach(item => {
            s += `
              <tr>
                <td class="px-6 py-3">${stt++}</td>
                <td class="px-6 py-3">${item.MaND}</td>
                <td class="px-6 py-3">${item.HoTen}</td>
                <td class="px-6 py-3">${item.CuTru}</td>
              </tr>`;
          });
          $('.addListNongDan').html(s);
        }
      });
    }

    // Hi·ªÉn th·ªã b·∫£ng th·ª≠a ƒë·∫•t
    function showThuaDat(){
      $.ajax({
        url: "http://localhost/qlvt/php/Thua_Dat/api_get_thua_dat.php",
        type: "POST",
        dataType: "json",
        success: function(res) {
          let s = '';
          let stt = 1;
          res.forEach(item => {
            s += `
              <tr>
                <td class="px-6 py-3">${stt++}</td>
                <td class="px-6 py-3">${item.MaTD}</td>
                <td class="px-6 py-3">${item.MaND}</td>
                <td class="px-6 py-3">${item.DiaChi}</td>
              </tr>`;
          });
          $('.addListThuaDat').html(s);
        }
      });
    }

    // Hi·ªÉn th·ªã b·∫£ng v·ª• tr·ªìng
    function showVuTrong(){
      $.ajax({
        url: "http://localhost/qlvt/php/Vu_Trong/api_get_trong.php",
        type: "POST",
        dataType: "json",
        success: function(res) {
          let s = '';
          let stt = 1;
          if (res.status === "success" && Array.isArray(res.data)) {
            res.data.forEach(item => {
              s += `
                <tr>
                  <td class="px-6 py-3">${stt++}</td>
                  <td class="px-6 py-3">${item.MaND || ""}</td>
                  <td class="px-6 py-3">${item.MaTD || ""}</td>
                  <td class="px-6 py-3">${item.MaC || ""}</td>
                  <td class="px-6 py-3">${item.ThoiGianBatDau || ""}</td>
                  <td class="px-6 py-3">${item.ThoiGianKetThuc || ""}</td>
                </tr>`;
            });
          }
          $('.addListVuTrong').html(s);
        }
      });
    }

    // H√†m lo·∫°i b·ªè d·∫•u ti·∫øng Vi·ªát
    function removeVietnameseTones(str) {
      str = str.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
      str = str.replace(/ƒë/g, 'd').replace(/ƒê/g, 'D');
      return str;
    }

    // H√†m l·ªçc b·∫£ng theo t·ª´ kh√≥a, li√™n k·∫øt c√°c b·∫£ng v√† m·ªü r·ªông cho b·∫£ng V·ª• tr·ªìng, t√≠nh c·∫£ tr∆∞·ªùng h·ª£p c√≥ d·∫•u/kh√¥ng d·∫•u
    function filterTables(keyword) {
      keyword = keyword.toLowerCase();
      let keywordNoSign = removeVietnameseTones(keyword);

      // --- C√¢y tr·ªìng ---
      let cayTrongFound = false;
      let matchedMaC = [];
      $('.addListCayTrong tr').each(function() {
        let tds = $(this).find('td');
        let maC = tds.eq(1).text().trim();
        let tenC = tds.eq(2).text().toLowerCase();
        let cachCanhTac = tds.eq(3).text().toLowerCase();
        let phanBon = tds.eq(4).text().toLowerCase();
        let nguonGoc = tds.eq(5).text().toLowerCase();

        let allText = [
          maC, tenC, cachCanhTac, phanBon, nguonGoc
        ].map(txt => txt.toLowerCase() + removeVietnameseTones(txt.toLowerCase())).join(' ');

        if (allText.includes(keyword) || allText.includes(keywordNoSign)) {
          matchedMaC.push(maC);
          $(this).show();
          cayTrongFound = true;
        } else {
          $(this).hide();
        }
      });

      // --- N√¥ng d√¢n ---
      let nongDanFound = false;
      let matchedMaND = [];
      $('.addListNongDan tr').each(function() {
        let tds = $(this).find('td');
        let maND = tds.eq(1).text().trim();
        let hoTen = tds.eq(2).text().toLowerCase();
        let cuTru = tds.eq(3).text().toLowerCase();

        let allText = [
          maND, hoTen, cuTru
        ].map(txt => txt.toLowerCase() + removeVietnameseTones(txt.toLowerCase())).join(' ');

        if (allText.includes(keyword) || allText.includes(keywordNoSign)) {
          matchedMaND.push(maND);
          $(this).show();
          nongDanFound = true;
        } else {
          $(this).hide();
        }
      });

      // --- Th·ª≠a ƒë·∫•t ---
      let thuaDatFound = false;
      let matchedMaTD = [];
      $('.addListThuaDat tr').each(function() {
        let tds = $(this).find('td');
        let maTD = tds.eq(1).text().trim();
        let maND_td = tds.eq(2).text().trim();
        let diaChi = tds.eq(3).text().toLowerCase();

        let allText = [
          maTD, maND_td, diaChi
        ].map(txt => txt.toLowerCase() + removeVietnameseTones(txt.toLowerCase())).join(' ');

        if (allText.includes(keyword) || allText.includes(keywordNoSign)) {
          matchedMaTD.push(maTD);
          $(this).show();
          thuaDatFound = true;
        } else {
          $(this).hide();
        }
      });

      // --- V·ª• tr·ªìng ---
      let vuTrongFound = false;
      $('.addListVuTrong tr').each(function() {
        let tds = $(this).find('td');
        let maND_vt = tds.eq(1).text().trim();
        let maTD_vt = tds.eq(2).text().trim();
        let maC_vt = tds.eq(3).text().trim();
        let thoiGianBatDau = tds.eq(4).text().toLowerCase();
        let thoiGianKetThuc = tds.eq(5).text().toLowerCase();

        let allText = [
          maND_vt, maTD_vt, maC_vt, thoiGianBatDau, thoiGianKetThuc
        ].map(txt => txt.toLowerCase() + removeVietnameseTones(txt.toLowerCase())).join(' ');

        if (
          allText.includes(keyword) || allText.includes(keywordNoSign) ||
          matchedMaC.includes(maC_vt) ||
          matchedMaND.includes(maND_vt) ||
          matchedMaTD.includes(maTD_vt)
        ) {
          $(this).show();
          vuTrongFound = true;
        } else {
          $(this).hide();
        }
      });

      // ·∫®n b·∫£ng n·∫øu kh√¥ng c√≥ d√≤ng n√†o hi·ªÉn th·ªã
      $('.addListCayTrong').closest('.bg-white.shadow-lg').toggle(cayTrongFound || keyword === "");
      $('.addListNongDan').closest('.bg-white.shadow-lg').toggle(nongDanFound || keyword === "");
      $('.addListThuaDat').closest('.bg-white.shadow-lg').toggle(thuaDatFound || keyword === "");
      $('.addListVuTrong').closest('.bg-white.shadow-lg').toggle(vuTrongFound || keyword === "");

      // Hi·ªÉn th·ªã th√¥ng b√°o n·∫øu kh√¥ng c√≥ k·∫øt qu·∫£
      if (!cayTrongFound && !nongDanFound && !thuaDatFound && !vuTrongFound && keyword !== "") {
        if ($('#noResultMsg').length === 0) {
          $('<div id="noResultMsg" class="text-center text-red-500 text-lg font-semibold my-8">Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£</div>')
            .insertAfter('.flex.justify-center.mb-8');
        }
      } else {
        $('#noResultMsg').remove();
      }
    }

    // Xu·∫•t b·∫£ng ra Excel
    function exportTableToExcel(tbodySelector, filename) {
      var tbody = document.querySelector(tbodySelector);
      if (!tbody) return;
      var table = tbody.closest('table');
      var wb = XLSX.utils.table_to_book(table, {sheet: "Sheet1"});
      XLSX.writeFile(wb, filename);
    }

    // Xu·∫•t t·∫•t c·∫£ b·∫£ng ra 1 file Excel
    function exportAllTablesToExcel() {
      var wb = XLSX.utils.book_new();
      var tableCayTrong = document.querySelector('.addListCayTrong').closest('table');
      var wsCayTrong = XLSX.utils.table_to_sheet(tableCayTrong);
      XLSX.utils.book_append_sheet(wb, wsCayTrong, "C√¢y tr·ªìng");

      var tableNongDan = document.querySelector('.addListNongDan').closest('table');
      var wsNongDan = XLSX.utils.table_to_sheet(tableNongDan);
      XLSX.utils.book_append_sheet(wb, wsNongDan, "N√¥ng d√¢n");

      var tableThuaDat = document.querySelector('.addListThuaDat').closest('table');
      var wsThuaDat = XLSX.utils.table_to_sheet(tableThuaDat);
      XLSX.utils.book_append_sheet(wb, wsThuaDat, "Th·ª≠a ƒë·∫•t");

      var tableVuTrong = document.querySelector('.addListVuTrong').closest('table');
      var wsVuTrong = XLSX.utils.table_to_sheet(tableVuTrong);
      XLSX.utils.book_append_sheet(wb, wsVuTrong, "V·ª• tr·ªìng");

      XLSX.writeFile(wb, "BangThongTin.xlsx");
    }

    // S·ª± ki·ªán
    $(document).ready(function(){
      showCayTrong();
      showNongDan();
      showThuaDat();
      showVuTrong();

      $('#searchInput').on('input', function() {
        filterTables($(this).val());
      });

      $('#exportCayTrong').on('click', function() {
        exportTableToExcel('.addListCayTrong', 'CayTrong.xlsx');
      });
      $('#exportNongDan').on('click', function() {
        exportTableToExcel('.addListNongDan', 'NongDan.xlsx');
      });
      $('#exportThuaDat').on('click', function() {
        exportTableToExcel('.addListThuaDat', 'ThuaDat.xlsx');
      });
      $('#exportVuTrong').on('click', function() {
        exportTableToExcel('.addListVuTrong', 'VuTrong.xlsx');
      });
      $('#exportAllExcel').on('click', function() {
        exportAllTablesToExcel();
      });
    });
  </script>
</body>
</html>
